version: 2.1
orbs:
  aws-ecr: circleci/aws-ecr@6.8.2
  kube-orb: circleci/kubernetes@0.11.0
  aws-eks: circleci/aws-eks@0.2.7

jobs:
  setup:
    docker:
      - image: circleci/node:10.15.3
    working_directory: ~/app
    steps:
      - checkout
      - run:
          name: Update npm
          command: "sudo npm install -g npm@latest"
      - restore_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
      - run:
          name: Install npm
          command: npm install
      - save_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - node_modules
      - save_cache:
          key: v1-repo-{{ .Branch }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ~/app
  test:
    docker:
      - image: circleci/node:10.15.3
    working_directory: ~/app
    steps:
      - restore_cache:
          key: v1-repo-{{ .Branch }}-{{ .Environment.CIRCLE_SHA1 }}
      - restore_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
      - run:
          name: Test code
          command: npm test
      - persist_to_workspace:
          root: ~/app
          paths:
            - .

  build_image_and_deploy_staging:
    docker:
      - image: circleci/python:3.7

    working_directory: ~/app

    steps:
      - attach_workspace:
          at: ~/app

      # - run:
      #     name: Install awscli and gettext-base
      #     command: |
      #       sudo pip3 install awscli
      # - run:
      #     name: Install aws-iam-authenticator
      #     command: |
      #       curl -o aws-iam-authenticator curl -o aws-iam-authenticator https://amazon-eks.s3-us-west-2.amazonaws.com/1.13.7/2019-06-11/bin/linux/amd64/aws-iam-authenticator
      #       chmod +x ./aws-iam-authenticator
      #       sudo mv ./aws-iam-authenticator /usr/local/bin/aws-iam-authenticator

      - setup_remote_docker
      - aws-ecr/build-and-push-image:
          repo: ${REPOSITORY_NAME}
          tag: ${CIRCLE_BUILD_NUM}
      - kube-orb/install-kubectl
      - aws-eks/update-kubeconfig-with-authenticator:
          cluster-name: rp-ccits-eks-demo
          aws-region: us-east-2
          install-kubectl: true
      - run:
          name: kubectl command 
          command: | 
            kubectl set image deployment/eks-demo ${REPOSITORY_NAME}=${AWS_REPOSITORY_URL}/${REPOSITORY_NAME}:${CIRCLE_BUILD_NUM}

workflows:
  build-test-and-deploy:
    jobs:
      - setup
      - test:
          requires:
            - setup
      - build_image_and_deploy_staging:
          requires:
            - test
          filters:
            branches:
              only:
                - master